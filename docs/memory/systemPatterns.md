# システムパターン

## アーキテクチャパターン

### 全体アーキテクチャ
1. クリーンアーキテクチャ
   - ドメインロジックの分離
   - 依存関係の制御
   - テスト容易性の確保

2. マイクロサービス的アプローチ
   - フロントエンド（React, Vercelでホスト）
   - バックエンド（FastAPI, Replitでホスト）
   - データベース（PostgreSQL, Neonでホスト）

3. レイヤー構造
   - プレゼンテーション層（React Components）
   - ビジネスロジック層（Services）
   - データアクセス層（Repositories）
   - インフラストラクチャ層（API/DB）

4. デプロイメントアーキテクチャ図
   ```mermaid
   graph TD
       User[ユーザー] --> FE[フロントエンド (React on Vercel)];
       FE --> BE[バックエンド (FastAPI on Replit)];
       BE --> DB[データベース (PostgreSQL on Neon)];
   ```

### フロントエンドアーキテクチャ (`src/app`)
1. コンポーネント設計
   - 機能ベースのコンポーネント分割
   - プレゼンテーション/コンテナパターン (部分的に適用)
   - レスポンシブデザイン

2. レンダリング戦略
   - Three.js (@react-three/fiber) による3D描画 (PC/モバイル共通)
   - パフォーマンス最適化パターン (モバイル含む)
   - メモリ管理パターン

3. 状態管理
   - Redux Toolkitによる中央集権的状態管理 (検討中、現在は主にローカルステート)
   - ローカルステート活用
   - メモ化による最適化

3. ルーティング
   - シンプルなページ構造
   - 履歴管理
   - ディープリンク対応

### バックエンドアーキテクチャ
1. APIデザイン
   - RESTful原則
   - OpenAPI（Swagger）仕様
   - エラーハンドリング標準化
   - 命名規則
     - 天体座標：right_ascension（赤経）, declination（赤緯）
     - 略語を避ける（ra → right_ascension）
     - 明確な意味を持つ名前を使用
     - 一貫性のある命名規則の適用

2. データモデル
   - SQLiteによる永続化（旧開発環境）
   - PostgreSQLによる永続化（ローカル開発環境）
   - Neon (PostgreSQL) による永続化（本番環境）
   - モデル間の関係定義
   - マイグレーション管理 (Alembic, 現在は未使用)

## 設計パターン

### 実装パターン
1. フロントエンド
   - Observer Pattern（イベント処理）
   - Factory Pattern（コンポーネント生成）
   - Command Pattern（操作履歴）
   - Adapter Pattern（外部サービス連携など）
   - レスポンシブデザインパターン
   - タッチインタラクションパターン (実装予定)

2. バックエンド
   - Repository Pattern（データアクセス）
   - Service Pattern（ビジネスロジック）
   - Dependency Injection
   - Unit of Work

### データパターン
1. スキーマ設計
   - Star（星のデータ）
   - Constellation（星座データ）
   - ConstellationLine（星座線データ）
   - UserPreference（ユーザー設定）

2. キャッシュ戦略
   - メモリキャッシュ
   - ローカルストレージ
   - データ更新ポリシー

## コーディング規約

### 共通規約
1. 命名規則
   - キャメルケース（JavaScript）
   - スネークケース（Python）
   - 意図が明確な命名

2. コメント
   - 日本語でのドキュメント
   - コードの意図の説明
   - TODO/FIXMEマーカー

3. ファイル構成
   - 機能ごとのモジュール分割
   - インデックスファイルの活用
   - テストファイルの配置

### JavaScript/React規約
1. コンポーネント
   - Function Componentの使用
   - Hooksの命名規則
   - Props型定義

2. スタイリング
   - CSS-in-JS
   - テーマシステム
   - レスポンシブデザイン

3. テスト
   - Jest + React Testing Library
   - スナップショットテスト
   - インテグレーションテスト

### Python規約
1. コードスタイル
   - PEP 8準拠
   - 型ヒントの使用
   - docstring（日本語）

2. 関数設計
   - 単一責任の原則
   - 引数の型アノテーション
   - 戻り値の型定義

3. テスト
   - pytestの使用
   - フィクスチャの活用
   - モック/スタブの使用

## 品質管理パターン

### テスト戦略
1. WSL環境でのテストパターン
   - プロセス分離パターン
     - 開発サーバーとテストの分離実行
     - ポート管理の一元化
     - プロセスクリーンアップの自動化
   - エラーハンドリングパターン
     - 再試行メカニズム
     - グレースフルシャットダウン
     - エラーログの集中管理
   - リソース管理パターン
     - メモリ使用量の監視
     - ポートの動的割り当て
     - テンポラリファイルの自動クリーンアップ

2. テストレベル
   - ユニットテスト（80%以上のカバレッジ）
   - インテグレーションテスト
   - E2Eテスト
   - ビジュアルリグレッションテスト

2. テスト自動化
   - CI/CDパイプライン
   - 自動テスト実行
   - カバレッジレポート

### コード品質
1. 静的解析
   - ESLint（JavaScript）
   - Flake8（Python）
   - TypeScript型チェック
   - モバイル向けベストプラクティス
   - クロスプラットフォーム互換性チェック

2. コードレビュー
   - プルリクエストレビュー
   - コードオーナーシップ
   - ペアプログラミング

3. パフォーマンス
   - バンドルサイズ最適化
   - メモリリーク防止
   - レンダリング最適化

### 実行環境パターン
1. WSL固有のパターン
   - プロセス管理
     - シグナルハンドリング
     - プロセス間通信
     - リソース解放
   - ファイルシステム
     - パス解決
     - パーミッション管理
     - 一時ファイル処理
   - ネットワーク
     - ポートマッピング
     - プロキシ設定
     - ホスト名解決

2. 開発環境パターン
   - 環境分離
     - 開発/テスト/本番の分離
     - 依存関係の管理
     - 設定の外部化（`.env`ファイル、環境変数）
   - ツール連携
     - エディタ統合
     - デバッガ連携
     - ログ収集
   - データベース統一
     - ローカル開発環境と本番環境でPostgreSQLを使用

### セキュリティパターン
1. 入力検証
   - バリデーション
   - サニタイズ
   - エスケープ処理

2. 認証/認可
   - APIキー管理
   - アクセス制御
   - セッション管理

3. データ保護
   - 機密情報の管理
   - エラーメッセージの制御
   - ログ出力の制御
