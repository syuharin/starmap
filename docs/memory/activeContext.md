# アクティブコンテキスト

## 現在の開発フェーズ

### 実装済みの主要機能
1. 星図表示基盤
   - オリオン座と北斗七星の表示
   - 星の等級に応じた大きさ調整
   - 星座線の表示
   - 夏の大三角（アステリズム）の表示
   - 日本語名とバイエル符号の表示

2. カメラ制御
   - 方位円中心視点の実装
   - 広視野角（75度）
   - 北向き初期視点（水平位置）
   - スムーズな回転アニメーション
   - 回転軸の最適化（YXZ順）
   - 視点範囲の制限（天頂〜地平線）

3. 検索機能
   - 星や星座の名前検索
   - 日本語・英語対応
   - インクリメンタル検索
   - 検索結果のリアルタイム表示

4. 日時指定機能
   - DateTimePickerによる日時選択
   - 過去100年から未来100年までの範囲
   - 地方恒星時（LST）の計算（フロントエンドでの計算精度向上）
   - 選択日時での星座位置更新

5. 補助線表示
   - 高度線の表示（0度から80度まで10度間隔）
   - 高度のラベル表示
   - 表示/非表示の切り替え機能
   - 半透明表示による視認性の確保

### 進行中の開発タスク
1. フロントエンド開発 (統合コードベース)
   - レスポンシブデザインの実装 (進行中)
   - Three.js パフォーマンスのモバイル最適化 (進行中)
   - UI/UX改善 (進行中)

2. データベース拡張
   - ✅ 夏の大三角 (アステリズム) の追加完了 (ベガ, アルタイル, デネブ含む)
   - 星座データの追加 (進行中 - カシオペア座、さそり座など)
   - 多言語対応の強化 (計画中)
   - パフォーマンス最適化 (進行中)
   - データ更新メカニズム (計画中)

3. UI/UX改善 (統合)
   - レスポンシブ対応 (進行中)
   - アクセシビリティ対応 (計画中)
   - パフォーマンス最適化 (進行中)
   - エラーハンドリング (進行中)

4. デプロイ準備
   - Vercel/Replit/Neon へのデプロイ完了済み
   - フロントエンド（Vercel）: ビルドコマンド `npm run build` を使用
   - バックエンド（Replit）: PostgreSQL (Neon) 連携済み
   - Infrastructure as Code (Replitは `.replit` ファイルで設定済み)
   - ローカル環境でのPostgreSQL動作確認済み
   - **クラウドデプロイ完了 (Vercel/Replit/Neon)**

## アクティブな課題

### 技術的課題
1. 開発環境の最適化
   - Windows環境対応の完了
     - 開発スクリプトの修正
     - セットアップガイドの整備
     - 環境依存の最小化
   - WSL環境での開発
     - テスト実行の安定性確保
     - プロセス管理の最適化
     - ポート競合の解決
     - ブラウザ連携の改善
   - **ローカルCI環境の整備:**
     - フロントエンド (`npm run ci:frontend`) の設定完了。
     - バックエンド (`run_ci_backend.sh`/`.bat`) の設定完了。
     - Flake8エラーの修正完了 (`black` フォーマッター導入、未使用コード削除、複雑性解消)。
     - ✅ **pytestがテストを検出できない問題は解決済み。** (テストディレクトリ構造を修正し、サンプルテストを追加)
     - ✅ **フロントエンドCI (`npm run ci:frontend`) の安定化完了。**
       - ESLint v9 (flat config) への対応 (`eslint.config.js` 作成、`@babel/eslint-parser` 導入、`globals` 設定修正、プラグイン/ルール設定見直し)。
       - ES Module環境下での設定ファイル読み込み問題解決 (`babel.config.cjs`, `webpack.config.cjs` へのリネーム)。
       - テスト実行環境の改善 (`concurrently` と `wait-on` を使用したサーバー起動同期、ポート競合 (`EADDRINUSE`) の解決)。
       - Puppeteerテストの安定化 (ヘッドレスモードでのWebGL問題調査、テストセレクタ修正 (`data-testid` 導入)、タイムアウト調整)。

2. WebGL関連
   - パフォーマンス最適化
   - メモリ使用量の削減
   - モバイル対応
   - フォールバック機能 (2D Canvas)

2. データ処理
   - 大規模データの効率的な処理 (進行中)
   - キャッシュ戦略の改善 (計画中)
   - リアルタイム更新の最適化 (計画中)
   - オフライン対応 (計画中)

3. レスポンシブ対応とモバイル最適化
   - レスポンシブデザインの実装 (進行中)
   - モバイルデバイスでの Three.js パフォーマンス最適化 (進行中)
   - タッチ操作への対応 (計画中)

### 機能的課題
1. 位置情報連携
   - GPS統合
   - 位置情報の精度向上
   - 方位磁石との連携
   - リアルタイム更新

### 解決済みの課題
   - **クラウドデプロイ:** Vercel/Replit/Neonへのデプロイと動作確認完了
   - **天体データ:** 夏の大三角（アステリズム）の追加
   - **ローカルCI:**
     - ✅ バックエンド Flake8エラーの修正完了
     - ✅ フロントエンド (`npm run ci:frontend`) の安定化完了 (ESLint設定、テスト環境、Puppeteerテストの問題解決)

2. 天体データ
   - 惑星の表示機能
   - 星雲・星団の表示
   - データの正確性向上

3. ユーザー体験
   - 初期ロード時間の短縮
   - 操作性の改善
   - エラー時の対応
   - ヘルプ機能の充実

## 重要な決定事項

### 開発環境
1. WSL環境
   - プロセス分離による安定性確保
   - 独立したテスト環境の構築
   - 自動化されたクリーンアップ
   - エラーハンドリングの強化
 2. ローカルデータベース
    - PostgreSQLを使用（`.env`ファイルで`DATABASE_URL`を設定）
    - 開発環境と本番環境のDBを統一
    - 初期データは `src/backend/init_db.py` によって `src/backend/data/` 内のCSVファイルから投入される

3. テスト戦略
   - ヘッドレステストの実装
   - 環境依存の最小化
   - 自動化されたスクリーンショット比較
   - 継続的なテスト実行

### アーキテクチャ決定
1. フロントエンド (`src/app`)
   - Three.js (@react-three/fiber) による3D描画 (PC/モバイル共通)
   - React + Material-UI による UI 構築
   - 単一コードベースによるレスポンシブ対応
   - クロスプラットフォーム対応 (Web)
     - Windows/Linux環境での動作確認済み
     - 開発スクリプトの標準化済み

2. バックエンド
   - FastAPIの採用
   - PostgreSQL (Neon) の使用
   - Skyfieldによる天体計算
   - RESTful API設計

3. デプロイ戦略
   - フロントエンド：Vercelへのデプロイ
     - ビルドコマンド: `npm run build`
     - 環境変数による設定管理 (`REACT_APP_API_URL`)
   - バックエンド：Replitへのデプロイ
     - 環境変数による設定管理 (`DATABASE_URL`, `FRONTEND_URL`)
     - `.replit` ファイルによる設定済み
    - データベース：Neon (PostgreSQL)
      - 初期化は `src/backend/init_db.py` で実行（既存データをクリアし、CSVからデータを投入）
      - 自動バックアップ (Neonの機能)

### アーキテクチャ改善
4. API設計の標準化
   - フィールド名の統一（right_ascension, declination）
   - レスポンス形式の一貫性確保
   - 命名規則の確立
   - バリデーション強化

1. データモデル
   - Star（星）エンティティの設計
   - Constellation（星座）の構造
   - 多言語対応の実装方法
   - データ更新戦略

2. UI/UX
   - 方位円中心視点の採用
   - 広視野角（75度）の設定
   - 夜間モードの実装
   - 検索機能の設計

3. パフォーマンス
   - WebGLの最適化戦略
   - データのキャッシュ方針
   - バンドルサイズの最適化
   - メモリ管理方針

## 次期開発計画

### 短期目標（1-2ヶ月）
1. フロントエンド統合後の安定化と改善
   - レスポンシブデザインの実装・改善
   - モバイルデバイスでの Three.js パフォーマンス最適化
   - UI/UXの最適化 (PC/モバイル共通)
   - テスト環境の整備 (統合コードベース向け)

2. 既存機能の改善
   - パフォーマンス最適化 (継続)
   - バグ修正
   - UI/UX改善 (継続)
   - ✅ **API呼び出しの信頼性向上**: バックエンドAPI呼び出しにリトライ機能（指数バックオフ、最大3回）を追加し、バックエンドのスリープからの復帰に対応。 (`src/app/services/starService.js`)
   - ドキュメント更新 (メモリーバンク等)

3. クラウドデプロイ (完了済み、維持・監視)
   - Vercel/Replit/Neon の監視
   - CI/CD設定 (改善検討)
   - 監視・ロギング設定 (改善検討)

### 中期目標（3-6ヶ月）
1. 新機能の追加
   - GPS連携機能
   - より多くの星座
   - 詳細な天体情報
   - オフライン対応

2. プラットフォーム拡張 (Web中心)
   - PWA (Progressive Web App) 化の検討
   - クロスプラットフォーム対応 (Web) の強化
   - 配布システムの整備 (Web)
   - ユーザーサポート体制

### 長期目標（6ヶ月以上）
1. 機能拡張
   - AR機能の実装
   - ソーシャル機能
   - 教育機関向け機能
   - API公開

2. コミュニティ育成
   - ドキュメントの充実
   - コントリビューションの促進
   - コミュニティサポート
   - イベント開催

## 現在の作業と次のステップ
- **現在の作業:** フロントエンドCI (`npm run ci:frontend`) の安定化作業完了。メモリーバンクの更新。
- **状況:** フロントエンドのローカルCIが正常に動作するようになった。ただし、テストのために `Constellation.jsx` にラップ用 `div` を追加した影響で、表示領域が狭くなる問題が発生したが、`height: '100%'` スタイルを追加して解決済み。PuppeteerテストのWebGL検証は一時的に無効化している。
- **次のステップ:**
    1. メモリーバンクの他のファイル (`techContext.md`, `progress.md`) を更新する。
    2. (必要であれば) PuppeteerテストのWebGL検証 (`validateRendering`) を再度有効化し、根本的な解決策を探る。
    3. バックエンドのテスト基盤整備 (`src/backend/tests/` へのテストケース追加、カバレッジ向上) に戻る。
